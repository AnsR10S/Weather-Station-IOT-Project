#include <SPI.h>
#include <Ethernet.h>
#include <BlynkSimpleEthernet.h>
#include <DHT.h>
#include <Wire.h>
#include <Adafruit_BMP085_U.h>

// DHT11 sensor configuration
#define DHTPIN 2        // PD2 (pin 4)
#define DHTTYPE DHT11   // DHT11 sensor type

// Initialize DHT11
DHT dht(DHTPIN, DHTTYPE);

// Blynk authentication token
#define BLYNK_AUTH_TOKEN "EeoTXKqiXhoLZ19pZRLTMsktXmsF3bDA"
char auth[] = BLYNK_AUTH_TOKEN;

// Initialize BMP180 sensor
Adafruit_BMP085_Unified bmp;

void setup() {
  // Start the Serial Monitor for debugging
  Serial.begin(9600);

  // Initialize the DHT11 sensor
  dht.begin();

  // Start Blynk
  Blynk.begin(auth);

  // Initialize BMP180 sensor and check for successful connection
  if (!bmp.begin()) {
    Serial.println("BMP180 not detected. Check wiring!");
    while (1);  // Halt the program if BMP180 isn't detected
  } else {
    Serial.println("BMP180 detected and initialized!");
  }
}

void loop() {
  Blynk.run();

  // Read temperature and humidity from DHT11
  float dhtTemperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  if (!isnan(dhtTemperature)) {
    Serial.print("DHT11 Temperature: ");
    Serial.print(dhtTemperature);
    Serial.println(" °C");
    Blynk.virtualWrite(V0, dhtTemperature);  // Send to virtual pin V0
  } else {
    Serial.println("Failed to read temperature from DHT sensor");
  }

  if (!isnan(humidity)) {
    Serial.print("DHT11 Humidity: ");
    Serial.print(humidity);
    Serial.println(" %");
    Blynk.virtualWrite(V1, humidity);  // Send to virtual pin V1
  } else {
    Serial.println("Failed to read humidity from DHT sensor");
  }

  // Read temperature and pressure from BMP180
  float bmpTemperature;
  float pressure;

  bmp.getTemperature(&bmpTemperature);
  bmp.getPressure(&pressure);

  if (!isnan(bmpTemperature) && !isnan(pressure)) {
    Serial.print("BMP180 Temperature: ");
    Serial.print(bmpTemperature);
    Serial.println(" °C");
    Blynk.virtualWrite(V2, bmpTemperature);  // Send BMP180 temp to virtual pin V2

    pressure = pressure / 100.0F;  // Convert pressure to hPa
    Serial.print("BMP180 Pressure: ");
    Serial.print(pressure);
    Serial.println(" hPa");
    Blynk.virtualWrite(V3, pressure);  // Send BMP180 pressure to virtual pin V3
  } else {
    Serial.println("Error reading BMP180 data.");
  }

  delay(5000);
}
